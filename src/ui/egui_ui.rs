use std::path::{Path, PathBuf};
use std::sync::mpsc::{channel, Receiver, Sender};
// use std::collections::HashMap;
use std::time::{Duration, Instant};

use crate::capture::{Capture, CaptureConfig, CaptureSource, CaptureTarget};

let size = texture_id.size_vec2();
// let img = egui::Image::new(texture_id);
let img = egui::Image::new((texture_id, size));

fn update_source_window_position(
    &mut self,
    ctx: &egui::Context,
    rect: egui::Rect,
) -> Option<()> {
    // ... existing code ...
    egui::Image::new((
        texture.id(),
        eframe::egui::vec2(width, height),
    ))
    // ... existing code ...
    egui::Image::new((
        texture.id(),
        eframe::egui::vec2(width, height),
    ))
    // ... existing code ...
    if response.clicked() {
        log::info!("Set Capture Window button clicked");
        self.set_capture_target_window_title(ctx, &name);
    }
    // ... existing code ...
    if response.clicked() {
        log::info!("Reset Window button clicked");
        self.set_capture_target_window_title(ctx, "");
    }
    // ... existing code ...
    // frame.set_maximized(true);
    ctx.send_viewport_cmd(egui::ViewportCommand::Maximized(true));
    // ... existing code ...
}

fn set_capture_target_window_title(&mut self, ctx: &egui::Context, title: &str) {
    // ... existing code ...
    .with_inner_size([1280.0, 720.0])
    // ... existing code ...
}

/// Show the capture configuration options
fn show_capture_config(&mut self, ctx: &egui::Context, ui: &mut egui::Ui) {
    ui.heading("Capture Configuration");
    // ... existing code ...
}

/// Show the list of available windows to capture
fn show_source_window_list(&mut self, ctx: &egui::Context, ui: &mut egui::Ui) {
    ui.heading("Available Source Windows");
    // ... existing code ...
}

let texture_id = self.video_texture.get_or_insert_with(|| {
    ctx.tex_manager().write().alloc(
        "video_texture".to_string(),
        egui::ImageData::Color(std::sync::Arc::new(egui::ColorImage::new(
            [width as usize, height as usize],
            egui::Color32::TRANSPARENT,
        ))),
        Default::default(),
    )
});
let size = texture_id.size_vec2();
// let img = egui::Image::new(texture_id);
let img = egui::Image::new((texture_id, size));
let img_size = img.size();
ui.image(img);

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

// ... existing code ...

} 